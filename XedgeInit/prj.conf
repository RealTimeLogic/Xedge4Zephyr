# Xedge Test Application Configuration for native_sim

# Enable Xedge module
CONFIG_XEDGE=y
CONFIG_XEDGE_STACK_SIZE=32768
#2Mb dlmalloc heap - see main.c
CONFIG_XEDGE_HEAP_SIZE=2097152
CONFIG_XEDGE_MAX_THREADS=2





# --- Sockets / contexts / FDs ---
# Each TCP connection consumes a net_context and a POSIX FD.
CONFIG_NET_MAX_CONTEXTS=64
CONFIG_NET_MAX_CONN=64
CONFIG_NET_SOCKETS_POLL_MAX=64

# --- Reduce TIME-WAIT hoarding (careful, but practical for sim) ---
# Default TIME-WAIT in Zephyr is conservative; lower it for bursty tests.
CONFIG_NET_TCP_TIME_WAIT_DELAY=2000

# --- Buffers (keep or increase from earlier tuning) ---
# Ensure pools don't starve when you scale connections.
CONFIG_NET_BUF_DATA_SIZE=512
CONFIG_NET_BUF_RX_COUNT=128
CONFIG_NET_BUF_TX_COUNT=128
CONFIG_NET_PKT_RX_COUNT=128
CONFIG_NET_PKT_TX_COUNT=128

# --- Debug aids (temporarily) ---
CONFIG_LOG=y
CONFIG_LOG_DEFAULT_LEVEL=3
CONFIG_NET_LOG=y
CONFIG_NET_STATISTICS=y
CONFIG_NET_STATISTICS_USER_API=y


# Networking - Essential for HTTP server
CONFIG_NETWORKING=y
CONFIG_NET_IPV4=y
CONFIG_NET_IPV6=y
CONFIG_NET_TCP=y
CONFIG_NET_UDP=y
CONFIG_NET_SOCKETS=y
CONFIG_SNTP=y

# DNS server for Internet resolution
CONFIG_DNS_RESOLVER=y
# Allow specifying DNS servers via Kconfig
CONFIG_DNS_SERVER_IP_ADDRESSES=y
CONFIG_DNS_SERVER1="8.8.8.8"
# Helpful if some domains have big/long answers
CONFIG_DNS_RESOLVER_ADDITIONAL_BUF_CTR=3
CONFIG_DNS_NUM_CONCUR_QUERIES=3

# Network buffers and memory
#CONFIG_NET_BUF_RX_COUNT=128
#CONFIG_NET_BUF_TX_COUNT=128
#CONFIG_NET_PKT_RX_COUNT=128
#CONFIG_NET_PKT_TX_COUNT=128
#CONFIG_NET_BUF_DATA_SIZE=512
#CONFIG_NET_MAX_CONTEXTS=32

# TCP settings for HTTP server
#CONFIG_NET_TCP_MAX_SEND_WINDOW_SIZE=16384
#CONFIG_NET_TCP_MAX_RECV_WINDOW_SIZE=16384
CONFIG_NET_TCP_WORKQ_STACK_SIZE=2048

# Network configuration for native_sim
CONFIG_NET_CONFIG_AUTO_INIT=y
CONFIG_NET_CONFIG_SETTINGS=y
CONFIG_NET_CONFIG_NEED_IPV4=y

# Zephyr app IP (inside the simulated network)
CONFIG_NET_CONFIG_MY_IPV4_ADDR="10.200.200.2"
# Host TAP (gateway)
CONFIG_NET_CONFIG_PEER_IPV4_ADDR="10.200.200.1"
# Default Gateway (host TAP)
CONFIG_NET_CONFIG_MY_IPV4_GW="10.200.200.1"


# Threading and scheduling
CONFIG_MULTITHREADING=y
CONFIG_NUM_PREEMPT_PRIORITIES=16
CONFIG_NUM_COOP_PRIORITIES=16
CONFIG_MAIN_STACK_SIZE=32768
CONFIG_IDLE_STACK_SIZE=2048
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=4096

# Memory management
CONFIG_HEAP_MEM_POOL_SIZE=131072
CONFIG_DYNAMIC_THREAD=y

# Console and shell
CONFIG_CONSOLE=y
CONFIG_UART_CONSOLE=y
CONFIG_SHELL=y
CONFIG_SHELL_BACKEND_SERIAL=y
CONFIG_SHELL_STACK_SIZE=4096

# POSIX API (helps with BAS porting layer)
CONFIG_POSIX_API=y
CONFIG_ZVFS_OPEN_MAX=64
CONFIG_NET_MAX_CONTEXTS=32
CONFIG_NET_MAX_CONN=32

CONFIG_EVENTFD=y

# Entropy (required for network randomization)
CONFIG_ENTROPY_GENERATOR=y
CONFIG_TEST_RANDOM_GENERATOR=y

# Disable assertions for cleaner output
#CONFIG_ASSERT=y
#CONFIG_ASSERT_LEVEL=0

# Network native simulator specific
CONFIG_NET_NATIVE=y

# Increase various limits for BAS
CONFIG_MAIN_THREAD_PRIORITY=5

# GPIO (optional - for LED examples)
CONFIG_GPIO=y

# File system support
# Zephyr VFS + LittleFS on simulated flash
CONFIG_FILE_SYSTEM=y
CONFIG_FILE_SYSTEM_LITTLEFS=y
CONFIG_FLASH=y
CONFIG_FLASH_MAP=y
CONFIG_FLASH_SIMULATOR=y
# Expose the simulated filesystem to the host (native_sim only)
CONFIG_FUSE_FS_ACCESS=y
